generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  master_br
  admin
  regional
  franchisee
}

enum UserStatus {
  active
  blocked
  inactive
  pending
}

enum RegionalType {
  admin
  simples
}

enum MasterType {
  admin
  simples
}

enum MotorcycleStatus {
  active
  alugada
  relocada
  manutencao
  recolhida
  indisponivel_rastreador
  indisponivel_emplacamento
  inadimplente
  renegociado
  furto_roubo
}

enum RentalStatus {
  active
  completed
  cancelled
  paused
}

enum ClientStatus {
  ativo
  inativo
  bloqueado
}

enum DriverStatus {
  active
  inactive
}

enum ContractStatus {
  draft
  generated
  sent
  signed
  cancelled
}

enum FinanceiroTipo {
  entrada
  saida
}

enum CategoriaTipo {
  entrada
  saida
  ambos
}

enum FrequenciaRecorrente {
  semanal
  quinzenal
  mensal
}

enum VistoriaType {
  entrada
  saida
  periodica
}

enum VistoriaStatus {
  pendente
  aprovada
  reprovada
}

enum LeadSource {
  instagram_proprio
  indicacao
  espontaneo
  google
}

enum MotorcycleType {
  Nova
  Usada
}

// ============================================
// MODELS
// ============================================

model AppUser {
  id                      String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                   String        @unique
  name                    String?
  role                    String        @default("franchisee")
  regional_type           String?
  master_type             String?
  status                  String        @default("pending")
  city_id                 String?       @db.Uuid
  franchisee_id           String?       @db.Uuid
  avatar_url              String?
  plugsign_token          String?
  menu_permissions        Json?         // Permissões de menu para usuários simples

  // Campos de autenticação (novos - migração)
  password_hash           String?
  refresh_token           String?
  refresh_token_expires_at DateTime?
  failed_login_attempts   Int           @default(0)
  locked_until            DateTime?
  last_login              DateTime?
  password_reset_token    String?
  password_reset_expires  DateTime?

  created_at              DateTime      @default(now())
  updated_at              DateTime      @updatedAt

  // Relações
  city                    City?         @relation(fields: [city_id], references: [id])
  franchisee              Franchisee?   @relation(fields: [franchisee_id], references: [id])

  // Relações inversas
  created_financeiro      Financeiro[]  @relation("CreatedByUser")
  created_recorrentes     LancamentoRecorrente[] @relation("CreatedByUser")
  created_vistorias       Vistoria[]    @relation("CreatedByUser")
  created_contracts       GeneratedContract[] @relation("CreatedByUser")
  attended_rentals        Rental[]      @relation("AttendantUser")
  created_rentals         Rental[]      @relation("CreatorUser")
  audit_logs              AuditLog[]
  created_surveys         SatisfactionSurvey[]
  survey_responses_as_franchisee SurveyResponse[] @relation("SurveyFranchiseeUser")
  survey_responses_as_regional   SurveyResponse[] @relation("SurveyRegionalUser")
  suggestions             Suggestion[]
  suggestion_reactions    SuggestionReaction[]
  roadmap_items           RoadmapItem[] @relation("RoadmapCreator")
  created_secondary_vehicles RentalSecondaryVehicle[] @relation("CreatedSecondaryVehicle")

  @@index([email])
  @@index([city_id])
  @@index([franchisee_id])
  @@index([refresh_token])
  @@map("app_users")
}

model City {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String
  slug             String   @unique
  plugsign_token   String?
  asaas_wallet_id  String?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  // Relações inversas
  users             AppUser[]
  franchisees       Franchisee[]
  motorcycles       Motorcycle[]
  rentals           Rental[]
  vistorias         Vistoria[]
  contracts         GeneratedContract[]
  rental_plans      RentalPlan[]
  survey_responses  SurveyResponse[]
  campaign_responses CampaignResponse[]
  distratos         Distrato[]
  vendas            Venda[]
  financialExpenses FinancialExpense[]

  @@map("cities")
}

model Franchisee {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cnpj                  String?
  company_name          String?
  fantasy_name          String?
  cpf                   String?
  nome_responsavel      String?
  endereco              String?
  email                 String?
  whatsapp_01           String?
  whatsapp_02           String?
  city_id               String   @db.Uuid
  status                String?  @default("active")
  royalties_percentage  Decimal? @db.Decimal(5, 2)
  moto_limit            Int?
  cooperloc_motos_count Int?
  asaas_token           String?
  master_user_id        String?  @db.Uuid
  user_id               String?  @db.Uuid
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  // Relações
  city                 City     @relation(fields: [city_id], references: [id])

  // Relações inversas
  users                AppUser[]
  motorcycles          Motorcycle[]
  rentals              Rental[]
  clients              Client[]
  financeiros          Financeiro[]
  recorrentes          LancamentoRecorrente[]
  vistorias            Vistoria[]
  survey_responses     SurveyResponse[]
  campaign_responses   CampaignResponse[]
  distratos            Distrato[]
  financialExpenses    FinancialExpense[]

  @@index([city_id])
  @@index([cnpj])
  // Índice composto para filtro cidade + status
  @@index([city_id, status])
  @@map("franchisees")
}

model Motorcycle {
  id                      String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  placa                   String
  chassi                  String?
  renavam                 String?
  modelo                  String
  marca                   String?
  ano                     Int?
  cor                     String?
  quilometragem           Int?
  status                  String           @default("active")
  codigo_cs               String?
  tipo                    String?
  valor_semanal           Decimal?         @db.Decimal(10, 2)
  data_ultima_mov         DateTime?
  data_criacao            DateTime?
  city_id                 String?          @db.Uuid
  franchisee_id           String?          @db.Uuid
  doc_moto                String?
  doc_taxa_intermediacao  String?
  observacoes             String?
  created_at              DateTime         @default(now())
  updated_at              DateTime         @updatedAt

  // Relações
  city                    City?            @relation(fields: [city_id], references: [id])
  franchisee              Franchisee?      @relation(fields: [franchisee_id], references: [id])

  // Relações inversas
  rentals                 Rental[]
  vistorias               Vistoria[]
  financeiros             Financeiro[]
  recorrentes             LancamentoRecorrente[]
  movements               MotorcycleMovement[]
  secondaryRentals        RentalSecondaryVehicle[]
  ordensServico           OrdemServico[]

  @@index([placa])
  @@index([city_id])
  @@index([franchisee_id])
  @@index([status])
  // Índices compostos para queries da página Locações
  @@index([city_id, status])
  @@index([city_id, created_at(sort: Desc)])
  @@map("motorcycles")
}

model MotorcycleMovement {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  motorcycle_id   String   @db.Uuid
  previous_status String?
  new_status      String
  reason          String?
  created_by      String?  @db.Uuid
  created_at      DateTime @default(now())

  // Relações
  motorcycle      Motorcycle @relation(fields: [motorcycle_id], references: [id])

  @@index([motorcycle_id])
  @@index([created_at])
  @@map("motorcycle_movements")
}

model MotorcycleModel {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brand      String
  model      String
  active     Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([brand, model])
  @@index([brand])
  @@index([active])
  @@map("motorcycle_models")
}

model Client {
  id                  String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  full_name           String
  cpf                 String?
  rg                  String?
  birth_date          DateTime?    @db.Date
  phone               String
  phone2              String?
  email               String?
  profession          String?
  address             String?
  number              String?
  city                String?
  state               String?
  zip_code            String?
  cnh_number          String?
  cnh_category        String?
  cnh_expiry_date     DateTime?    @db.Date
  cnh_photo_url       String?
  cnh_document_url    String?
  residence_proof_url String?
  is_pj               Boolean      @default(false)
  cnpj                String?
  razao_social        String?
  cpf_responsavel     String?
  status              String       @default("ativo")
  franchisee_id       String?      @db.Uuid
  city_id             String?      @db.Uuid
  created_at          DateTime     @default(now())
  updated_at          DateTime     @updatedAt

  // Relações
  franchisee          Franchisee?  @relation(fields: [franchisee_id], references: [id])

  // Relações inversas
  drivers             ClientDriver[]
  vistorias           Vistoria[]

  @@index([cpf])
  @@index([cnpj])
  @@index([franchisee_id])
  @@map("clients")
}

model ClientDriver {
  id                  String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id           String       @db.Uuid
  full_name           String
  rg                  String?
  cpf                 String
  birth_date          DateTime?    @db.Date
  email               String?
  phone               String?
  address_street      String?
  address_number      String?
  address_complement  String?
  address_neighborhood String?
  address_city        String?
  address_state       String?
  address_zip_code    String?
  cnh_number          String?
  cnh_category        String?
  cnh_expiry_date     DateTime?    @db.Date
  cnh_document_url    String?
  residence_proof_url String?
  status              String       @default("active")
  created_at          DateTime     @default(now())
  updated_at          DateTime     @updatedAt

  // Relações
  client              Client       @relation(fields: [client_id], references: [id], onDelete: Cascade)

  // Relações inversas
  rentals             Rental[]

  @@index([client_id])
  @@index([cpf])
  @@map("client_drivers")
}

model RentalPlan {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  description     String?
  daily_rate      Decimal  @db.Decimal(10, 2)
  weekly_rate     Decimal? @db.Decimal(10, 2)
  monthly_rate    Decimal? @db.Decimal(10, 2)
  minimum_days    Int?
  maximum_days    Int?
  deposit_amount  Decimal? @db.Decimal(10, 2)
  is_active       Boolean  @default(true)
  status          String?
  city_id         String?  @db.Uuid
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relações
  city            City?    @relation(fields: [city_id], references: [id])

  // Relações inversas
  rentals         Rental[]

  @@map("rental_plans")
}

model Rental {
  id                        String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_name               String
  client_cpf                String
  client_email              String?
  client_phone              String
  client_address            String?
  client_address_street     String?
  client_address_number     String?
  client_address_city       String?
  client_address_state      String?
  client_address_zip_code   String?
  driver_id                 String?      @db.Uuid
  driver_name               String?
  driver_cpf                String?
  driver_phone              String?
  driver_cnh                String?
  driver_address_street     String?
  driver_address_number     String?
  driver_address_city       String?
  driver_address_state      String?
  driver_address_zip_code   String?
  motorcycle_id             String       @db.Uuid
  motorcycle_plate          String
  franchisee_id             String?      @db.Uuid
  city_id                   String?      @db.Uuid
  attendant_id              String?      @db.Uuid
  plan_id                   String?      @db.Uuid
  start_date                DateTime     @db.Date
  end_date                  DateTime?    @db.Date
  actual_return_date        DateTime?    @db.Date
  km_inicial                Int?
  km_final                  Int?
  total_days                Int?
  daily_rate                Decimal      @db.Decimal(10, 2)
  total_amount              Decimal?     @db.Decimal(10, 2)
  deposit_amount            Decimal?     @db.Decimal(10, 2)
  status                    String       @default("active")
  payment_status            String?
  lead_source               String?
  notes                     String?
  created_by                String?      @db.Uuid
  created_at                DateTime     @default(now())
  updated_at                DateTime     @updatedAt

  // Relações
  motorcycle                Motorcycle   @relation(fields: [motorcycle_id], references: [id])
  franchisee                Franchisee?  @relation(fields: [franchisee_id], references: [id])
  city                      City?        @relation(fields: [city_id], references: [id])
  attendant                 AppUser?     @relation("AttendantUser", fields: [attendant_id], references: [id])
  plan                      RentalPlan?  @relation(fields: [plan_id], references: [id])
  driver                    ClientDriver? @relation(fields: [driver_id], references: [id])
  creator                   AppUser?     @relation("CreatorUser", fields: [created_by], references: [id])

  // Relações inversas
  vistorias                 Vistoria[]
  contracts                 GeneratedContract[]
  distratos                 Distrato[]
  secondaryVehicles         RentalSecondaryVehicle[]

  @@index([franchisee_id])
  @@index([city_id])
  @@index([motorcycle_id])
  @@index([status])
  @@index([start_date])
  // Índices compostos para queries da página Locações
  @@index([city_id, start_date(sort: Desc)])
  @@index([franchisee_id, start_date(sort: Desc)])
  @@index([status, start_date(sort: Desc)])
  @@index([city_id, status])
  @@map("rentals")
}

model Distrato {
  id                   String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  placa                String
  franqueado           String
  inicio_ctt           DateTime    @db.Date
  fim_ctt              DateTime    @db.Date
  motivo               String
  causa                String
  franchisee_id        String?     @db.Uuid
  city_id              String?     @db.Uuid
  rental_id            String?     @db.Uuid
  client_name          String?
  modelo_moto          String?
  data_distrato        DateTime?   @db.Date
  pdf_url              String?
  termo_url            String?
  status               String      @default("draft")
  signature_request_id String?
  document_key         String?     // Chave do documento para download no PlugSign
  signed_file_url      String?     // URL do documento assinado
  signed_at            DateTime?   // Data da assinatura
  created_at           DateTime?   @default(now())
  updated_at           DateTime?   @updatedAt

  // Relações
  franchisee      Franchisee? @relation(fields: [franchisee_id], references: [id])
  city            City?       @relation(fields: [city_id], references: [id])
  rental          Rental?     @relation(fields: [rental_id], references: [id])

  // Relações inversas
  vistorias       Vistoria[]

  @@index([franchisee_id])
  @@index([city_id])
  @@index([rental_id])
  // Índice composto para busca de distratos por locação
  @@index([rental_id, created_at(sort: Desc)])
  @@map("distratos_locacoes")
}

model RentalSecondaryVehicle {
  id                   String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rental_id            String      @db.Uuid
  motorcycle_id        String      @db.Uuid
  start_date           DateTime    @db.Date
  end_date             DateTime?   @db.Date
  status               String      @default("active") // active, completed, cancelled
  motivo               String?     // Motivo da troca/adição
  notes                String?

  // Dados do Termo Aditivo
  termo_aditivo_url    String?     // URL do PDF do termo
  signature_request_id String?     // ID do PlugSign
  document_key         String?     // Chave para download
  signed_file_url      String?     // URL do documento assinado
  signed_at            DateTime?   // Data da assinatura
  termo_status         String      @default("draft") // draft, pending_signature, signed

  created_by           String?     @db.Uuid
  created_at           DateTime    @default(now())
  updated_at           DateTime    @updatedAt

  // Relações
  rental               Rental      @relation(fields: [rental_id], references: [id])
  motorcycle           Motorcycle  @relation(fields: [motorcycle_id], references: [id])
  creator              AppUser?    @relation("CreatedSecondaryVehicle", fields: [created_by], references: [id])

  @@index([rental_id])
  @@index([motorcycle_id])
  @@index([status])
  // Índice composto para busca de veículos secundários por locação
  @@index([rental_id, status])
  @@map("rental_secondary_vehicles")
}

model ContractType {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  category    String
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relações inversas
  templates   ContractTemplate[]

  @@map("contract_types")
}

model ContractTemplate {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contract_type_id String   @db.Uuid
  name             String
  version          String   @default("1.0")
  title            String
  content          Json
  variables        Json     @default("[]")
  is_active        Boolean  @default(true)
  is_default       Boolean  @default(false)
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  // Relações
  contract_type    ContractType @relation(fields: [contract_type_id], references: [id])

  // Relações inversas
  clauses          ContractClause[]
  contracts        GeneratedContract[]

  @@index([contract_type_id])
  @@map("contract_templates")
}

model ContractClause {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  template_id   String   @db.Uuid
  clause_number String
  title         String
  content       String
  order_index   Int
  is_required   Boolean  @default(true)
  variables     Json     @default("[]")
  created_at    DateTime @default(now())

  // Relações
  template      ContractTemplate @relation(fields: [template_id], references: [id], onDelete: Cascade)

  @@index([template_id])
  @@map("contract_clauses")
}

model GeneratedContract {
  id                   String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  template_id          String         @db.Uuid
  rental_id            String?        @db.Uuid
  contract_number      String         @unique
  contract_data        Json
  pdf_url              String?
  status               String         @default("draft")
  signature_request_id String?
  batch_id             String?
  document_key         String?
  signed_at            DateTime?
  expires_at           DateTime?
  city_id              String?        @db.Uuid
  created_by           String?        @db.Uuid
  created_at           DateTime       @default(now())
  updated_at           DateTime       @updatedAt

  // Relações
  template             ContractTemplate @relation(fields: [template_id], references: [id])
  rental               Rental?          @relation(fields: [rental_id], references: [id])
  city                 City?            @relation(fields: [city_id], references: [id])
  creator              AppUser?         @relation("CreatedByUser", fields: [created_by], references: [id])

  @@index([rental_id])
  @@index([status])
  @@index([signature_request_id])
  @@map("generated_contracts")
}

model CategoriaFinanceiro {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nome        String
  tipo        String
  descricao   String?
  ativo       Boolean      @default(true)
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt

  // Relações inversas
  financeiros Financeiro[]
  recorrentes LancamentoRecorrente[]

  @@map("categorias_financeiro")
}

model Financeiro {
  id               String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  franchisee_id    String         @db.Uuid
  tipo             String
  placa            String?
  motorcycle_id    String?        @db.Uuid
  categoria_id     String?        @db.Uuid
  locatario        String?
  valor            Decimal        @db.Decimal(10, 2)
  data             DateTime       @db.Date
  descricao        String
  pago             Boolean        @default(false)
  comprovante_url  String?
  comprovante_url_2 String?
  created_by       String?        @db.Uuid
  created_at       DateTime       @default(now())
  updated_at       DateTime       @updatedAt

  // Relações
  franchisee       Franchisee     @relation(fields: [franchisee_id], references: [id])
  motorcycle       Motorcycle?    @relation(fields: [motorcycle_id], references: [id])
  categoria        CategoriaFinanceiro? @relation(fields: [categoria_id], references: [id])
  creator          AppUser?       @relation("CreatedByUser", fields: [created_by], references: [id])

  // Relações inversas
  historico_recorrente LancamentoRecorrenteHistorico[]

  @@index([franchisee_id])
  @@index([data])
  @@index([tipo])
  @@map("financeiro")
}

model LancamentoRecorrente {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  franchisee_id   String              @db.Uuid
  tipo            String
  placa           String?
  motorcycle_id   String?             @db.Uuid
  categoria_id    String?             @db.Uuid
  locatario       String?
  valor           Decimal             @db.Decimal(10, 2)
  descricao       String
  frequencia      String
  dia_vencimento  Int?
  data_inicio     DateTime            @db.Date
  data_fim        DateTime?           @db.Date
  ativo           Boolean             @default(true)
  created_by      String?             @db.Uuid
  created_at      DateTime            @default(now())
  updated_at      DateTime            @updatedAt

  // Relações
  franchisee      Franchisee          @relation(fields: [franchisee_id], references: [id])
  motorcycle      Motorcycle?         @relation(fields: [motorcycle_id], references: [id])
  categoria       CategoriaFinanceiro? @relation(fields: [categoria_id], references: [id])
  creator         AppUser?            @relation("CreatedByUser", fields: [created_by], references: [id])

  // Relações inversas
  historico       LancamentoRecorrenteHistorico[]

  @@index([franchisee_id])
  @@index([ativo])
  @@map("lancamentos_recorrentes")
}

model LancamentoRecorrenteHistorico {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recorrente_id String   @db.Uuid
  financeiro_id String   @db.Uuid
  data_geracao  DateTime @db.Date
  created_at    DateTime @default(now())

  // Relações
  recorrente    LancamentoRecorrente @relation(fields: [recorrente_id], references: [id], onDelete: Cascade)
  financeiro    Financeiro           @relation(fields: [financeiro_id], references: [id], onDelete: Cascade)

  @@index([recorrente_id])
  @@index([financeiro_id])
  @@map("lancamentos_recorrentes_historico")
}

model FinancialExpense {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  franchisee_id    String   @db.Uuid
  city_id          String   @db.Uuid
  expense_type     String
  amount           Decimal  @db.Decimal(10, 2)
  reference_month  Int
  reference_year   Int
  motorcycle_count Int?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  franchisee       Franchisee @relation(fields: [franchisee_id], references: [id])
  city             City       @relation(fields: [city_id], references: [id])

  @@unique([franchisee_id, expense_type, reference_month, reference_year])
  @@index([franchisee_id])
  @@index([reference_year, reference_month])
  @@map("financial_expenses")
}

model Rastreador {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cnpj        String?
  empresa     String?
  franqueado  String?
  chassi      String?
  placa       String?
  rastreador  String?
  tipo        String?
  moto        String?
  mes         String?
  valor       String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([placa])
  @@index([franqueado])
  @@index([mes])
  @@map("rastreadores")
}

model Vistoria {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rental_id       String?       @db.Uuid
  distrato_id     String?       @db.Uuid
  motorcycle_id   String        @db.Uuid
  city_id         String?       @db.Uuid
  franchisee_id   String?       @db.Uuid
  client_id       String?       @db.Uuid
  inspection_date DateTime      @db.Date
  inspection_type String
  status          String         @default("pendente")
  mileage         String?
  placa           String?
  locadora        String?
  locatario       String?
  observations    String?
  data_hora       DateTime?
  photo_1_path    String?
  photo_2_path    String?
  photo_3_path    String?
  photo_4_path    String?
  photo_5_path    String?
  photo_6_path    String?
  photo_7_path    String?
  photo_8_path    String?
  photo_9_path    String?
  photo_10_path   String?
  created_by      String?       @db.Uuid
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt

  // Relações
  rental          Rental?       @relation(fields: [rental_id], references: [id])
  distrato        Distrato?     @relation(fields: [distrato_id], references: [id])
  motorcycle      Motorcycle    @relation(fields: [motorcycle_id], references: [id])
  city            City?         @relation(fields: [city_id], references: [id])
  franchisee      Franchisee?   @relation(fields: [franchisee_id], references: [id])
  client          Client?       @relation(fields: [client_id], references: [id])
  creator         AppUser?      @relation("CreatedByUser", fields: [created_by], references: [id])

  @@index([rental_id])
  @@index([motorcycle_id])
  @@index([city_id])
  @@index([franchisee_id])
  @@map("vistorias")
}

model AuditLog {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String?  @db.Uuid
  user_email      String?
  user_name       String?
  user_role       String?
  city_id         String?  @db.Uuid
  city_name       String?
  franchisee_id   String?  @db.Uuid
  franchisee_name String?
  action          String
  action_label    String?
  entity_type     String?
  entity_id       String?
  description     String?
  details         Json?
  old_data        Json?
  new_data        Json?
  changed_fields  String[]
  ip_address      String?
  user_agent      String?
  created_at      DateTime @default(now())

  // Relações
  user            AppUser? @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([action])
  @@index([entity_type, entity_id])
  @@index([created_at])
  @@map("audit_logs")
}

// Tabelas de Pesquisa de Satisfação
model SatisfactionSurvey {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String
  description       String?
  evaluation_period String
  start_date        DateTime @db.Timestamptz
  end_date          DateTime @db.Timestamptz
  status            String   @default("draft")
  created_by        String   @db.Uuid
  created_at        DateTime? @default(now()) @db.Timestamptz
  updated_at        DateTime? @default(now()) @db.Timestamptz

  // Relações
  creator           AppUser  @relation(fields: [created_by], references: [id])
  criteria          SurveyCriteria[]
  responses         SurveyResponse[]

  @@map("satisfaction_surveys")
}

model SurveyCriteria {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  survey_id   String   @db.Uuid
  name        String
  description String?
  order_index Int      @default(0)
  created_at  DateTime? @default(now()) @db.Timestamptz

  // Relações
  survey      SatisfactionSurvey @relation(fields: [survey_id], references: [id], onDelete: Cascade)
  ratings     SurveyRating[]

  @@index([survey_id])
  @@map("survey_criteria")
}

model SurveyResponse {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  survey_id         String    @db.Uuid
  franchisee_id     String    @db.Uuid
  franchisee_user_id String   @db.Uuid
  regional_user_id  String?   @db.Uuid
  city_id           String    @db.Uuid
  status            String    @default("pending")
  completed_at      DateTime? @db.Timestamptz
  general_comments  String?
  created_at        DateTime? @default(now()) @db.Timestamptz
  updated_at        DateTime? @default(now()) @db.Timestamptz

  // Relações
  survey            SatisfactionSurvey @relation(fields: [survey_id], references: [id], onDelete: Cascade)
  franchisee        Franchisee         @relation(fields: [franchisee_id], references: [id])
  franchiseeUser    AppUser            @relation("SurveyFranchiseeUser", fields: [franchisee_user_id], references: [id])
  regionalUser      AppUser?           @relation("SurveyRegionalUser", fields: [regional_user_id], references: [id])
  city              City               @relation(fields: [city_id], references: [id])
  ratings           SurveyRating[]

  @@index([survey_id])
  @@index([franchisee_id])
  @@index([city_id])
  @@map("survey_responses")
}

model SurveyRating {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  response_id      String   @db.Uuid
  criteria_id      String   @db.Uuid
  rating           Int
  specific_comment String?
  created_at       DateTime? @default(now()) @db.Timestamptz

  // Relações
  response         SurveyResponse @relation(fields: [response_id], references: [id], onDelete: Cascade)
  criteria         SurveyCriteria @relation(fields: [criteria_id], references: [id], onDelete: Cascade)

  @@unique([response_id, criteria_id])
  @@index([response_id])
  @@index([criteria_id])
  @@map("survey_ratings")
}

// Tabela de Campanhas (Marketing/WhatsApp)
model Campaign {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  description     String?
  type            String
  status          String   @default("draft")
  target_audience Json?
  content         Json?
  scheduled_at    DateTime?
  sent_at         DateTime?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@map("campaigns")
}

// Tabelas de Pesquisa de Campanhas (Votação de Franqueados)
model CampaignSurvey {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String
  description      String?
  campaign_details String?
  launch_period    String
  start_date       DateTime @db.Timestamptz
  end_date         DateTime @db.Timestamptz
  status           String   @default("draft")
  created_by       String   @db.Uuid
  created_at       DateTime? @default(now()) @db.Timestamptz
  updated_at       DateTime? @default(now()) @db.Timestamptz

  // Relações inversas
  responses        CampaignResponse[]

  @@map("campaign_surveys")
}

model CampaignResponse {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  campaign_id      String    @db.Uuid
  franchisee_id    String    @db.Uuid
  regional_user_id String?   @db.Uuid
  city_id          String    @db.Uuid
  vote             String    @default("accepted")
  observations     String?
  status           String    @default("pending")
  completed_at     DateTime? @db.Timestamptz
  created_at       DateTime? @default(now()) @db.Timestamptz
  updated_at       DateTime? @default(now()) @db.Timestamptz

  // Relações
  campaign         CampaignSurvey @relation(fields: [campaign_id], references: [id], onDelete: Cascade)
  franchisee       Franchisee     @relation(fields: [franchisee_id], references: [id])
  city             City           @relation(fields: [city_id], references: [id])

  @@unique([campaign_id, franchisee_id])
  @@index([campaign_id])
  @@index([franchisee_id])
  @@index([city_id])
  @@map("campaign_responses")
}

// Tabela de Instâncias Evolution (WhatsApp)
model EvolutionInstance {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  instance_name   String   @unique
  instance_id     String?
  status          String   @default("disconnected")
  qr_code         String?
  phone_number    String?
  franchisee_id   String?  @db.Uuid
  city_id         String?  @db.Uuid
  webhook_url     String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@map("evolution_instances")
}

// Tabela de Conversas IA
model IaConversation {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String   @db.Uuid
  title           String?
  messages        Json     @default("[]")
  context         Json?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@index([user_id])
  @@map("ia_conversations")
}

// Tabela de Sugestões
model Suggestion {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String?  @db.Uuid
  title           String
  description     String
  status          String   @default("open")
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relações
  user            AppUser?  @relation(fields: [user_id], references: [id])
  reactions       SuggestionReaction[]

  @@map("suggestions")
}

model SuggestionReaction {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  suggestion_id   String   @db.Uuid
  user_id         String   @db.Uuid
  reaction_type   String   // 'like' ou 'dislike'
  created_at      DateTime @default(now())

  // Relações
  suggestion      Suggestion @relation(fields: [suggestion_id], references: [id], onDelete: Cascade)
  user            AppUser    @relation(fields: [user_id], references: [id])

  @@unique([suggestion_id, user_id])
  @@index([suggestion_id])
  @@index([user_id])
  @@map("suggestion_reactions")
}

model RoadmapItem {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title           String
  description     String
  status          String    @default("planned") // planned, in_progress, completed, cancelled
  priority        String    @default("medium")  // low, medium, high, critical
  estimated_date  DateTime? @db.Date
  completed_date  DateTime?
  order_index     Int       @default(0)
  created_by      String?   @db.Uuid
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  // Relações
  creator         AppUser?  @relation("RoadmapCreator", fields: [created_by], references: [id])

  @@index([status])
  @@index([priority])
  @@map("roadmap_items")
}

// Tabela de Leads
model Lead {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String
  phone           String
  email           String?
  source          String?
  status          String   @default("new")
  notes           String?
  franchisee_id   String?  @db.Uuid
  city_id         String?  @db.Uuid
  assigned_to     String?  @db.Uuid
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@index([franchisee_id])
  @@index([city_id])
  @@map("leads")
}

// Tabela de Deals (Vendas)
model Deal {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  lead_id         String?  @db.Uuid
  title           String
  value           Decimal? @db.Decimal(10, 2)
  stage           String   @default("prospecting")
  probability     Int?
  expected_close  DateTime? @db.Date
  notes           String?
  franchisee_id   String?  @db.Uuid
  city_id         String?  @db.Uuid
  assigned_to     String?  @db.Uuid
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@index([franchisee_id])
  @@index([city_id])
  @@map("deals")
}

// Tabela de Manutenções (Ordens de Serviço)
model Manutencao {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  motorcycle_id   String   @db.Uuid
  franchisee_id   String?  @db.Uuid
  city_id         String?  @db.Uuid
  tipo            String
  descricao       String?
  status          String   @default("aberta")
  data_entrada    DateTime @db.Date
  data_saida      DateTime? @db.Date
  valor_total     Decimal? @db.Decimal(10, 2)
  oficina         String?
  observacoes     String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relações inversas
  servicos        ManutencaoServico[]
  pecas           ManutencaoPeca[]

  @@index([motorcycle_id])
  @@index([franchisee_id])
  @@map("manutencoes")
}

model ManutencaoServico {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  manutencao_id   String   @db.Uuid
  descricao       String
  valor           Decimal  @db.Decimal(10, 2)
  created_at      DateTime @default(now())

  // Relações
  manutencao      Manutencao @relation(fields: [manutencao_id], references: [id], onDelete: Cascade)

  @@map("manutencao_servicos")
}

model ManutencaoPeca {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  manutencao_id   String   @db.Uuid
  nome            String
  quantidade      Int      @default(1)
  valor_unitario  Decimal  @db.Decimal(10, 2)
  created_at      DateTime @default(now())

  // Relações
  manutencao      Manutencao @relation(fields: [manutencao_id], references: [id], onDelete: Cascade)

  @@map("manutencao_pecas")
}

// Tabela de Ordens de Serviço (manutenções reais)
model OrdemServico {
  id                        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  numero_os                 String
  motorcycle_id             String?  @db.Uuid
  oficina_id                String?  @db.Uuid
  profissional_id           String?  @db.Uuid
  data_abertura             DateTime? @default(now())
  data_previsao             DateTime?
  data_conclusao            DateTime?
  status                    String?  @default("aberta")
  tipo_manutencao           String?
  km_atual                  Int?
  descricao_problema        String?
  diagnostico               String?
  solucao                   String?
  valor_pecas               Decimal? @db.Decimal
  valor_servicos            Decimal? @db.Decimal
  valor_total               Decimal? @db.Decimal
  observacoes               String?
  created_at                DateTime? @default(now())
  updated_at                DateTime? @default(now())
  created_by                String?  @db.Uuid
  city_id                   String?  @db.Uuid
  locatario                 String?
  aceite_franqueado         String?  @default("pendente")
  aceite_data               DateTime?
  financeiro_id             String?  @db.Uuid
  aceite_observacao         String?

  // Relações
  motorcycle                Motorcycle? @relation(fields: [motorcycle_id], references: [id])

  // Relações inversas
  servicos                  OrdemServicoServico[]
  pecas                     OrdemServicoPeca[]

  @@index([motorcycle_id])
  @@index([city_id])
  @@index([data_previsao])
  @@index([status])
  @@map("ordens_servico")
}

model OrdemServicoServico {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ordem_servico_id  String?  @db.Uuid
  servico_id        String?  @db.Uuid
  quantidade        Decimal? @default(1) @db.Decimal
  preco_unitario    Decimal  @db.Decimal
  preco_total       Decimal? @db.Decimal
  observacoes       String?
  created_at        DateTime? @default(now())

  // Relações
  ordemServico      OrdemServico? @relation(fields: [ordem_servico_id], references: [id], onDelete: Cascade)

  @@map("ordens_servico_servicos")
}

model OrdemServicoPeca {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ordem_servico_id  String?  @db.Uuid
  peca_id           String?  @db.Uuid
  quantidade        Decimal  @db.Decimal
  preco_unitario    Decimal  @db.Decimal
  preco_total       Decimal? @db.Decimal
  observacoes       String?
  created_at        DateTime? @default(now())

  // Relações
  ordemServico      OrdemServico? @relation(fields: [ordem_servico_id], references: [id], onDelete: Cascade)

  @@map("ordens_servico_pecas")
}

// Tabela de Recibos de Caução
model DepositReceipt {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rental_id            String?  @db.Uuid
  client_name          String
  client_cpf           String
  amount               Decimal  @db.Decimal(10, 2)
  payment_method       String?
  receipt_number       String?
  pdf_url              String?
  signature_request_id String?
  status               String         @default("draft")
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  @@index([rental_id])
  @@map("deposit_receipts")
}

// Tabela de Vendas de Motos
model Venda {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  data_compra     DateTime @db.Timestamptz
  parceiro        String
  status          String   @default("PENDENTE") // PAGO, PAGANDO, PENDENTE
  entregue        Boolean  @default(false)
  franqueado      String
  cnpj            String
  razao_social    String
  quantidade      Int      @default(0)
  marca           String
  modelo          String
  valor_unitario  Decimal  @db.Decimal(10, 2) @default(0)
  valor_total     Decimal  @db.Decimal(10, 2) @default(0)
  city_id         String?  @db.Uuid
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relações
  city            City?    @relation(fields: [city_id], references: [id])

  @@index([city_id])
  @@index([franqueado])
  @@index([data_compra])
  @@map("vendas")
}

// Tabela de Configurações Asaas
model AsaasConfig {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String   @unique @db.VarChar(100)
  value       String
  description String?
  is_secret   Boolean  @default(false)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("asaas_config")
}

// Tabela de Pagamentos Asaas
model AsaasPayment {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rental_id           String    @db.Uuid
  franchisee_id       String    @db.Uuid
  financeiro_id       String?   @db.Uuid
  asaas_payment_id    String    @db.VarChar
  asaas_customer_id   String?   @db.VarChar
  installment_number  Int
  due_date            DateTime  @db.Date
  valor               Decimal   @db.Decimal
  valor_royalties     Decimal   @db.Decimal
  status              String    @default("PENDING") @db.VarChar
  boleto_url          String?
  boleto_barcode      String?   @db.VarChar
  pix_qrcode          String?
  pix_copia_cola      String?
  paid_at             DateTime? @db.Timestamptz
  paid_value          Decimal?  @db.Decimal
  error_message       String?
  retry_count         Int?      @default(0)
  created_at          DateTime? @default(now()) @db.Timestamptz
  updated_at          DateTime? @default(now()) @db.Timestamptz

  @@map("asaas_payments")
}

// Tabela de Eventos de Pagamento Asaas
model AsaasPaymentEvent {
  id                        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  asaas_payment_id          String?   @db.Uuid
  event_type                String    @db.VarChar
  event_data                Json?
  asaas_payment_external_id String?   @db.VarChar
  webhook_id                String?   @db.VarChar
  processed                 Boolean?  @default(true)
  error_message             String?
  processed_at              DateTime? @default(now()) @db.Timestamptz
  created_at                DateTime? @default(now()) @db.Timestamptz

  @@map("asaas_payment_events")
}
